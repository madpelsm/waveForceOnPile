#include <morisson.h>
#include <stdlib.h>
#include <windowgui.h>
#include <cstring>

#define PARAM(X)       \
    if (#X == param) { \
        X = argument;  \
    };

double waveheight = 4, waterdepth = 10, period = 18, precision = 0.00001,
       pilediameter = 3, pileroughness = 0.00001, nu = 0.000001, timestep = 1,
       tstart = 0, tend = 0, dz = 1, xlocation = 0, timeinstant = 6,
       overTCalcStore = 1;

int width = 800, height = 600;
bool writepermition = 1, GUI = 1;

void setParameter(std::string _input) {
    std::string param = _input.substr(0, _input.find("="));
    double argument = std::atof(_input.substr(_input.find("=") + 1).c_str());
    std::vector<std::string> validCommands = {
        "waveheight",   "waterdepth",    "period", "precision",
        "pilediameter", "pileroughness", "nu",     "timestep",
        "tstart",       "tend",          "dz",     "xlocation",
        "timeinstant",  "height",        "width",  "writepermition",
        "GUI"};
    if (std::find(validCommands.begin(), validCommands.end(), param) !=
        validCommands.end()) {
        PARAM(waveheight);
        PARAM(waterdepth);
        PARAM(period);
        PARAM(precision);
        PARAM(pilediameter);
        PARAM(pileroughness);
        PARAM(nu);
        PARAM(timestep);
        PARAM(tstart);
        PARAM(tend);
        PARAM(dz);
        PARAM(xlocation);
        PARAM(timeinstant);
        PARAM(height);
        PARAM(width);
        PARAM(writepermition);
        PARAM(GUI);
        printf("set %s to %f\n", param.c_str(), argument);
    }

    if (param.compare("help") == 0) {
        std::string howto =
            "Possible commands are:\n"
            "\nwaveheight\nwaterdepth\nperiod\nprecision\npilediameter\npilerou"
            "ghness\nnu\ntimestep\ntstart\ntend\ndz (depth "
            "interval)\nxlocation\ntime\nheight (window height)\nwidth (window "
            "width)\nwritepermition (0 or 1)\n\nuse "
            "for example "
            "waveheight=12\n\n********************\n";
        printf("%s\n", howto.c_str());
    }
}

int main(int argc, char *argv[]) {
    for (size_t i = 0; i < argc; i++) {
        setParameter(argv[i]);
    }
    GUIWindow ge1(width, height, "waves App");
    /**********/
    // Wave info
    Panel waves("wave information");

    Variable waveH("waveheight", &waveheight);
    Variable waterD("waterdepth", &waterdepth);
    Variable waveT("period", &period);
    Variable waveP("precision", &precision);
    Variable visco("nu", &nu);

    std::vector<Variable *> waveVars = {&waveH, &waterD, &waveT, &waveP,
                                        &visco};
    waves.addVariables(&waveVars);

    ge1.addPanel(&waves);
    //*********/
    // Pile info
    Panel piles("pile information");

    piles.setPanelPosition(0, 380);
    Variable PileD("pilediameter", &pilediameter);
    Variable PileR("pileroughness", &pileroughness);

    std::vector<Variable *> pileVars = {&PileD, &PileR};
    piles.addVariables(&pileVars);  // why copy??

    ge1.addPanel(&piles);

    /*******/
    // calculation settings
    Panel calcSettings("Calculation Settings");

    calcSettings.setPanelPosition(0, 180);
    Variable timeStep("timestep", &timestep);
    Variable tStrt("start time", &tstart);
    Variable tEndt("end time", &tend);
    Variable stepSize("stepsize", &dz);
    Variable xlo("x location", &xlocation);
    Variable Tinstant("Time point", &timeinstant);
    Variable IntervalCalcStore("Store dt calcs", &overTCalcStore);

    std::vector<Variable *> calcVars = {&timeStep,         &tStrt, &tEndt,
                                        &stepSize,         &xlo,   &Tinstant,
                                        &IntervalCalcStore};

    calcSettings.addVariables(&calcVars);
    ge1.addPanel(&calcSettings);
    Wave wave;

    wave.setHeight(waveheight);
    wave.setWaterDepth(waterdepth);
    wave.setPeriod(period);
    wave.setPrecision(precision);
    Pile pile(pilediameter);
    pile.setSurfaceRoughness(pileroughness);

    wave.calculateWaveLength();
    Morisson *morisson1 = new Morisson(&pile, &wave);
    morisson1->setNu(nu);
    morisson1->setTimestep(timestep);

    if (overTCalcStore != 1.0) {
        morisson1->mOverTCalcStorage = false;
    } else {
        morisson1->moverTCalcStorage = true;
    }

    //  now triggered by button
    ButtonPanel simpleCalc("calculate at t");
    simpleCalc.setPosition(170, 0);

    ge1.addButtonPanel(&simpleCalc);
    // simpleCalc.buttonHelp->addButton("test", []() {});

    ge1.makeGUIWindow();
    // TIME TO PLACE BUTTONS
    simpleCalc.buttonHelp->addButton(simpleCalc.mName, [&morisson1, &ge1]() {
        morisson1->calculateForces(dz, timeinstant);
        MessageDialog *m = new MessageDialog(
            ge1.screen, MessageDialog::Type::Warning, "Calculated!",
            "Calculation completed, now press 'store calculation'", "ok");
    });
    simpleCalc.buttonHelp->addButton(
        "store calculation", [&morisson1]() { morisson1->storeCalculation(); });
    simpleCalc.buttonHelp->addButton("Calculate over time", [&morisson1,
                                                             &ge1]() {
        if (tend != tstart) {
            morisson1->calculateForcesOverTime(tstart, tend, dz, xlocation);
            MessageDialog *m = new MessageDialog(
                ge1.screen, MessageDialog::Type::Warning, "Calculation stored!",
                "The calculation has been stored.", "ok");

        } else {
            MessageDialog *m = new MessageDialog(
                ge1.screen, MessageDialog::Type::Warning, "start=end",
                "Please chose the end time different from the starttime", "ok");
        }
    });
    simpleCalc.buttonHelp->addButton("export calculation", [&morisson1]() {
        std::string fileLoc = file_dialog({{"csv", ""}}, true);
        printf("%s\n", fileLoc.c_str());
        morisson1->writeToFile(fileLoc);
    });

    if (tstart != tend) {
        morisson1->calculateForcesOverTime(tstart, tend, dz, xlocation);
    }
    if (writepermition) {
        morisson1->calculateForces(dz, timeinstant);
        morisson1->writeToFile();
    }
    // make window
    if (GUI) {
        ge1.startLoop();
    }
    delete morisson1;
    return 0;
}
